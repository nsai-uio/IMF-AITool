<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMF application</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        header { background-color: #2c3e50; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.2rem; }
        .controls { display: flex; gap: 10px; }
        #main-container { display: flex; flex: 1; overflow: hidden; }
        
        /* Chat Section */
        #chat-panel { width: 350px; background: #f8f9fa; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        #chat-history { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .message { padding: 10px; border-radius: 8px; max-width: 85%; word-wrap: break-word; }
        .user-msg { background-color: #3498db; color: white; align-self: flex-end; }
        .bot-msg { background-color: #e9ecef; color: #333; align-self: flex-start; }
        #chat-input-area { padding: 15px; border-top: 1px solid #ddd; display: flex; gap: 5px; background: white; }
        #question { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 8px 15px; background-color: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #34495e; }

        /* Visualization Section */
        #vis-panel { flex: 1; position: relative; background: white; }
        #cy { width: 100%; height: 100%; }
        .legend { position: absolute; bottom: 20px; right: 20px; background: rgba(255,255,255,0.9); padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 0.8rem; }
        .legend-item { display: flex; align-items: center; margin: 5px 0; }
        .color-box { width: 15px; height: 15px; margin-right: 8px; border-radius: 3px; }
    </style>
</head>
<body>
    <header>
        <h1>IMF application</h1>
        <div class="controls">
            <div style="display:flex; flex-direction:column; gap:5px;">
                <form id="uploadForm" style="display:flex; gap: 10px;">
                    <input type="file" name="file" accept=".pdf" required>
                    <button type="submit">Upload</button>
                </form>
                <div id="progress-container" style="display:none; width: 100%; background: #ddd; border-radius: 4px; height: 10px; overflow: hidden;">
                    <div id="progress-bar" style="width: 0%; height: 100%; background: #3498db; transition: width 0.5s;"></div>
                </div>
                <div id="status-text" style="font-size: 10px; color: #ccc; text-align: center;"></div>
            </div>
            <select id="fileSelect" onchange="loadData()">
                <option value="">-- Select Processed File --</option>
                {% for file in processed_files %}
                    {% if not file.endswith('_components.json') %}
                    <option value="{{ file }}">{{ file }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>
    </header>

    <div id="main-container">
        <div id="chat-panel">
            <div id="chat-history">
                <div class="message bot-msg">Select a file to ask questions.</div>
            </div>
            <div id="chat-input-area">
                <input type="text" id="question" placeholder="Ask a question..." onkeypress="if(event.key==='Enter') sendQuestion()">
                <button onclick="sendQuestion()">Send</button>
            </div>
        </div>
        <div id="vis-panel">
            <div id="cy"></div>
            <div class="legend">
                <div class="legend-item"><div class="color-box" style="background: #0074D9;"></div>Product</div>
                <div class="legend-item"><div class="color-box" style="background: #2ECC40;"></div>Function</div>
                <div class="legend-item"><div class="color-box" style="background: #FF851B;"></div>Terminal</div>
            </div>
        </div>
    </div>

    <script>
        let cy;

        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const submitBtn = this.querySelector('button');
            const originalText = submitBtn.textContent;
            
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const statusText = document.getElementById('status-text');

            submitBtn.disabled = true;
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            statusText.textContent = 'Starting...';

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(initData => {
                if (initData.error) {
                    alert(initData.error);
                    resetForm();
                } else {
                    const taskId = initData.task_id;
                    const pollInterval = setInterval(() => {
                        fetch(`/status/${taskId}`)
                            .then(res => res.json())
                            .then(statusData => {
                                if (statusData.status === 'processing') {
                                    progressBar.style.width = statusData.progress + '%';
                                    statusText.textContent = statusData.message;
                                } else if (statusData.status === 'completed') {
                                    clearInterval(pollInterval);
                                    progressBar.style.width = '100%';
                                    statusText.textContent = 'Complete!';
                                    updateFileSelect(statusData.processed_file);
                                    resetForm();
                                } else if (statusData.status === 'error') {
                                    clearInterval(pollInterval);
                                    alert('Error: ' + statusData.message);
                                    resetForm();
                                }
                            });
                    }, 1000);
                }
            })
            .catch(err => {
                console.error('Error:', err);
                resetForm();
            });

            function resetForm() {
                submitBtn.disabled = false;
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    statusText.textContent = '';
                }, 2000);
            }

            function updateFileSelect(filename) {
                const select = document.getElementById('fileSelect');
                let optionExists = Array.from(select.options).some(opt => opt.value === filename);
                
                if (!optionExists) {
                    const option = document.createElement('option');
                    option.value = filename;
                    option.text = filename;
                    select.add(option);
                }
                select.value = filename;
                loadData();
            }
        });

        function loadData() {
            const filename = document.getElementById('fileSelect').value;
            if (!filename) return;

            fetch(`/get_processed_data/${filename}`)
                .then(response => response.json())
                .then(data => {
                    renderGraph(data);
                })
                .catch(err => console.error('Error loading data:', err));
        }

        function sendQuestion() {
            const questionInput = document.getElementById('question');
            const question = questionInput.value.trim();
            const filename = document.getElementById('fileSelect').value;
            const chatHistory = document.getElementById('chat-history');

            if (!question) return;
            if (!filename) {
                alert("Please select a file first.");
                return;
            }

            // Add user message
            chatHistory.innerHTML += `<div class="message user-msg">${question}</div>`;
            questionInput.value = '';
            chatHistory.scrollTop = chatHistory.scrollHeight;

            fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question: question, filename: filename })
            })
            .then(response => response.json())
            .then(data => {
                const answer = data.answer || data.error || "No answer received.";
                chatHistory.innerHTML += `<div class="message bot-msg">${answer}</div>`;
                chatHistory.scrollTop = chatHistory.scrollHeight;
            })
            .catch(err => {
                console.error('Error:', err);
                chatHistory.innerHTML += `<div class="message bot-msg">Error communicating with server.</div>`;
            });
        }

        function renderGraph(data) {
            const elements = [];
            const nodes = new Set();

            const addNode = (id, type) => {
                if (!nodes.has(id)) {
                    let color = '#666';
                    let shape = 'rectangle';
                    if (type === 'component') { color = '#0074D9'; shape = 'rectangle'; }
                    else if (type === 'functionality') { color = '#2ECC40'; shape = 'round-rectangle'; }
                    else if (type === 'terminal') { color = '#FF851B'; shape = 'ellipse'; }

                    elements.push({ data: { id: id, label: id, type: type }, style: { 'background-color': color, 'shape': shape } });
                    nodes.add(id);
                }
            };

            Object.entries(data).forEach(([comp, details]) => {
                addNode(comp, 'component');

                if (details.partOf) {
                    details.partOf.forEach(parent => {
                        addNode(parent, 'component');
                        elements.push({ data: { source: comp, target: parent, label: 'partOf' }, classes: 'partOf' });
                    });
                }
                if (details.connectedTo) {
                    details.connectedTo.forEach(target => {
                        addNode(target, 'component');
                        elements.push({ data: { source: comp, target: target, label: 'connectedTo' }, classes: 'connectedTo' });
                    });
                }
                if (details.fulfills) {
                    details.fulfills.forEach(func => {
                        addNode(func, 'functionality');
                        elements.push({ data: { source: comp, target: func, label: 'fulfills' }, classes: 'fulfills' });
                    });
                }
                if (details.hasTerminal) {
                    details.hasTerminal.forEach(term => {
                        addNode(term, 'terminal');
                        elements.push({ data: { source: comp, target: term, label: 'hasTerminal' }, classes: 'hasTerminal' });
                    });
                }
            });

            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: elements,
                style: [
                    { selector: 'node', style: { 'label': 'data(label)', 'color': '#fff', 'text-valign': 'center', 'text-halign': 'center', 'width': 'label', 'height': 'label', 'padding': '10px', 'font-size': '10px', 'text-wrap': 'wrap', 'text-max-width': '100px' } },
                    { selector: 'edge', style: { 'width': 1, 'curve-style': 'bezier', 'target-arrow-shape': 'triangle', 'label': 'data(label)', 'font-size': '8px', 'text-rotation': 'autorotate', 'text-background-color': '#fff', 'text-background-opacity': 0.8 } },
                    { selector: '.partOf', style: { 'line-color': '#999', 'target-arrow-color': '#999', 'line-style': 'dashed' } },
                    { selector: '.connectedTo', style: { 'line-color': '#FF4136', 'target-arrow-color': '#FF4136' } },
                    { selector: '.fulfills', style: { 'line-color': '#2ECC40', 'target-arrow-color': '#2ECC40', 'line-style': 'dotted' } },
                    { selector: '.hasTerminal', style: { 'line-color': '#FF851B', 'target-arrow-color': '#FF851B' } }
                ],
                layout: { name: 'cose', animate: false, padding: 50, nodeRepulsion: 4500, idealEdgeLength: 100 }
            });
        }
    </script>
</body>
</html>